<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ProxyEndpoint name="CartProxyEndpoint">
    <Description/>
    <FaultRules>
        <FaultRule name="FaultHandling">
            <Step>
                <Name>cf_AssignErrorRespMessage</Name>
            </Step>
            <Step>
                <Name>cf_AssignAPIErrorToRespMessage</Name>
            </Step>
            <Step>
                <Name>cf_logError</Name>
            </Step>
        </FaultRule>
    </FaultRules>
    <PreFlow name="PreFlow">
        <Request>
            <Step>
                <Condition>(request.verb !="OPTIONS")</Condition>
                <Name>cf_OAuthValidateToken</Name>
            </Step>
            <Step>
                <Condition>request.content != ""</Condition>
                <Name>cf_JSONThreatProtection-</Name>
            </Step>
            <Step>
                <Name>cf_RetrieveEnvConfig</Name>
            </Step>
            <Step>
                <Name>cf_AassignStatic</Name>
            </Step>
            <Step>
                <Name>cf_initLog</Name>
            </Step>
        </Request>
        <Response/>
    </PreFlow>
    <PostFlow name="PostFlow">
        <Request/>
        <Response>
            <Step>
                <Name>cf_finalizeLog</Name>
            </Step>
        </Response>
    </PostFlow>
    <PostClientFlow name="PostClientFlow">
        <Response>
            <!-- Non Production Logging -->
            <Step>
                <Condition>(api.envcfg.splunkEnv="non-prod")</Condition>
                <Name>cf_Log_NonProd</Name>
            </Step>
            <!-- Production Logging -->
            <Step>
                <Condition>(api.envcfg.splunkEnv="prod")</Condition>
                <Name>cf_Log_Prod</Name>
            </Step>
        </Response>
    </PostClientFlow>
    <Flows>
        <Flow name="OptionsPreFlight">
            <Request/>
            <Response>
                <Step>
                    <Name>cf_addCORS</Name>
                </Step>
            </Response>
            <Condition>request.verb == "OPTIONS"</Condition>
        </Flow>
        <Flow name="createDefaultCart">
            <Description/>
            <Request>
                <Step>
                    <Name>createDefaultCart_AssignRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>createDefaultCart_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(request.queryparam.createDefault="true") and (proxy.pathsuffix MatchesPath "/") and (api.request.verb = "POST")</Condition>
        </Flow>
        <Flow name="createCart">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>createCart_AssignCreateRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCalloutWithZoom</Name>
                </Step>
                <Step>
                    <Name>log_defaultCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>createCart_createPlanConfigurationsRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_createPlanServiceCallout</Name>
                </Step>
                <Step>
                    <Name>createCart_createAddLineRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_createAddLineServiceCallout</Name>
                </Step>
                <Step>
                    <Name>createCart_createUpdateCartRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>createCart_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/") and (api.request.verb = "POST")</Condition>
        </Flow>
        <Flow name="getDefaultCart">
            <Description/>
            <Request>
                <Step>
                    <Name>getDefaultCart_AssignRoutingVariable</Name>
                </Step>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
            </Request>
            <Response>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/") and (api.request.verb = "GET")</Condition>
        </Flow>
        <Flow name="getCartPricePreview">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>getCartPricePreview_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>getCartPricePreview_cartPriceForBuildingCredit</Name>
                </Step>
                <Step>
                    <Name>log_cartPriceForBuildingCreditCallout</Name>
                </Step>
                <Step>
                    <Name>getCartPricePreview_cartPriceForGoodCredit</Name>
                </Step>
                <Step>
                    <Name>log_cartPriceForGoodCreditCallout</Name>
                </Step>
                <Step>
                    <Name>getCartPricePreview_cartPriceForNoneCredit</Name>
                </Step>
                <Step>
                    <Name>log_cartPriceForNoneCreditCallout</Name>
                </Step>
                <Step>
                    <Name>getCartPricePreview_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>getCartPricePreview_buildResponse</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/preview") and (request.verb = "GET")</Condition>
        </Flow>
        <Flow name="getCartByID">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>getCartByID_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>getCartByID_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}") and (request.verb = "GET")</Condition>
        </Flow>
        <Flow name="getCartWithCheckoutData">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>Callout.GetProfileId</Name>
                </Step>
                <Step>
                    <Name>log_getProfileIdServiceCallout</Name>
                </Step>
                <Step>
                    <Name>updateProfileIdResponse</Name>
                </Step>
                <Step>
                    <Name>Callout.GetProfileAddresses</Name>
                </Step>
                <Step>
                    <Name>log_getProfileAddressesServiceCallout</Name>
                </Step>
                <Step>
                    <Name>getCartWithCheckoutData_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>getCartWithCheckoutData_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/checkout") and (request.verb = "GET")</Condition>
        </Flow>
        <Flow name="addLine">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>addLine_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_createPlanServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addLine_createAddLineRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_createAddLineServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addLine_createUpdateCartRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addLine_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="duplicateLine">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>duplicateLine_extrectIDs</Name>
                </Step>
                <Step>
                    <Name>duplicateLine_AssignCreateRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>duplicateLine_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(request.queryparam.duplicate="true") and (proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="deleteLine">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>deleteLine_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>deleteLine_AssignCreateRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>deleteLine_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}") and (request.verb = "DELETE")</Condition>
        </Flow>
        <Flow name="addDeviceToLine">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>addDeviceToLine_ExtractVariables</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCalloutLookupItemForSKU</Name>
                </Step>
                <Step>
                    <Name>log_lookUpItemServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addDeviceToLine_ExtractItemID</Name>
                </Step>
                <Step>
                    <Name>addDeviceToLine_JSPrepareAdditemRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCalloutAddItem</Name>
                </Step>
                <Step>
                    <Name>log_addItemServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addDeviceToLine_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}/device") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="deleteDeviceFromLine">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>deleteDeviceFromLine_extrectIDs</Name>
                </Step>
                <Step>
                    <Name>deleteDeviceFromLine_AssignCreateRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>deleteDeviceFromLine_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}/device/{deviceId}") and (request.verb = "DELETE")</Condition>
        </Flow>
        <Flow name="addAccessory">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>addAccessory_ExtractVariables</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCalloutLookupItemForSKU</Name>
                </Step>
                <Step>
                    <Name>log_lookUpItemServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addAccessory_ExtractItemID</Name>
                </Step>
                <Step>
                    <Name>addAccessory_JSPrepareAdditemRequest</Name>
                </Step>
                <Step>
                    <Name>addAccessory_CalloutAddAccessory</Name>
                </Step>
                <Step>
                    <Name>log_addAccessoryServiceCallout</Name>
                </Step>
                <Step>
                    <Name>addAccessory_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/accessories") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="updateAccessory">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>updateAccessory_ExtractVariables</Name>
                </Step>
                <Step>
                    <Name>updateAccessory_PrepareAdditemRequest</Name>
                </Step>
                <Step>
                    <Name>updateAccessory_CalloutAddAccessory</Name>
                </Step>
                <Step>
                    <Name>log_updateAccessoryServiceCallout</Name>
                </Step>
                <Step>
                    <Name>updateAccessory_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/accessories/{accessoryID}") and (request.verb = "PUT")</Condition>
        </Flow>
        <Flow name="deleteAccessory">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>deleteAccessory_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>deleteAccessory_AssignCreateRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>deleteAccessory_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/accessories/{accessoryID}") and (request.verb = "DELETE")</Condition>
        </Flow>
        <Flow name="applyPromotion">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>applyPromotion_prepareRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>applyPromotion_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/promotions") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="removePromotion">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>removePromotion_prepareRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>removePromotion_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/promotions/{promoCode}") and (request.verb = "DELETE")</Condition>
        </Flow>
        <Flow name="getPlanConfigurations">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>getConfiguredPlans_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>getConfiguredPlans_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/plan-configurations") and (request.verb = "GET")</Condition>
        </Flow>
        <Flow name="createConfiguredPlans">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>createPlanConfigurations_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>createConfiguredPlans_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/plan-configurations") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="updateCart">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>updateCart_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>updateCart_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}") and (request.verb = "PUT")</Condition>
        </Flow>
        <Flow name="getServices">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>getservices_prepareRequest</Name>
                </Step>
                <Step>
                    <Name>getServices_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}/services") and (request.verb = "GET")</Condition>
        </Flow>
        <Flow name="bundleServices">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>bundleServices_ExtractVariables</Name>
                </Step>
                <Step>
                    <Name>bundleservices_prepareRequest</Name>
                </Step>
                <Step>
                    <Name>bundleServices_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}/services/bundle") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="updateServices">
            <Description/>
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>updateServices_ExtractVariables</Name>
                </Step>
                <Step>
                    <Name>updateServices_prepareRequest</Name>
                </Step>
                <Step>
                    <Name>cf_cortexTargetCallout</Name>
                </Step>
                <Step>
                    <Name>log_updateCartServiceCallout</Name>
                </Step>
                <Step>
                    <Name>updateServices_AssignRoutingVariable</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/lineofservices/{lineofserviceid}/services") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="getAuditRecords">
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>getAuditRecords_ExtractVariable</Name>
                </Step>
                <Step>
                    <Name>getAuditsRecord_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>getAuditRecords_ServiceCallout</Name>
                </Step>
                <Step>
                    <Name>log_getAuditRecordsServiceCallout</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>getAuditRecords</Name>
                </Step>
                <Step>
                    <Name>cf_addCORS</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/audit-records") and (request.verb = "GET")</Condition>
        </Flow>
        <Flow name="createAuditRecord">
            <Request>
                <Step>
                    <Name>getProxyFlowName_AssignVariable</Name>
                </Step>
                <Step>
                    <Name>auditRecord_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>createAudit_PrepareRequest</Name>
                </Step>
                <Step>
                    <Name>createAudit_serviceCallout</Name>
                </Step>
                <Step>
                    <Name>log_createAuditServiceCallout</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>createAuditRecord_AssignResponse</Name>
                </Step>
                <Step>
                    <Name>cf_addCORS</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/{cartID}/audit-records") and (request.verb = "POST")</Condition>
        </Flow>
    </Flows>
    <HTTPProxyConnection>
        <BasePath>/v1/carts</BasePath>
        <Properties/>
        <VirtualHost>secure</VirtualHost>
    </HTTPProxyConnection>
    <RouteRule name="CortexTargetEndPoint">
        <Condition>(api.target.route.system = "Cortex")</Condition>
        <TargetEndpoint>CortexTargetEndPoint</TargetEndpoint>
    </RouteRule>
    <RouteRule name="noRoute"/>
</ProxyEndpoint>
